<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>caffe: readme</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">caffe
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_examples_siamese_readme.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">readme </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><hr/>
<p> title: Siamese Network Tutorial description: Train and test a siamese network on MNIST data. category: example include_in_docs: true layout: default </p><h2>priority: 100 </h2>
<h1>Siamese Network Training with Caffe</h1>
<p class="">This example shows how you can use weight sharing and a contrastive loss function to learn a model using a siamese network in Caffe.</p>
<p class="">We will assume that you have caffe successfully compiled. If not, please refer to the <a href="../../installation.html">Installation page</a>. This example builds on the <a href="mnist.html">MNIST tutorial</a> so it would be a good idea to read that before continuing.</p>
<p class=""><em>The guide specifies all paths and assumes all commands are executed from the root caffe directory</em></p>
<h2>Prepare Datasets</h2>
<p class="">You will first need to download and convert the data from the MNIST website. To do this, simply run the following commands: </p><pre class="fragment">./data/mnist/get_mnist.sh
./examples/siamese/create_mnist_siamese.sh
</pre><p class="">After running the script there should be two datasets, <code>./examples/siamese/mnist_siamese_train_leveldb</code>, and <code>./examples/siamese/mnist_siamese_test_leveldb</code>.</p>
<h2>The Model</h2>
<p class="">First, we will define the model that we want to train using the siamese network. We will use the convolutional net defined in <code>./examples/siamese/mnist_siamese.prototxt</code>. This model is almost exactly the same as the <a href="mnist.html">LeNet model</a>, the only difference is that we have replaced the top layers that produced probabilities over the 10 digit classes with a linear "feature" layer that produces a 2 dimensional vector. </p><pre class="fragment">layer {
  name: "feat"
  type: "InnerProduct"
  bottom: "ip2"
  top: "feat"
  param {
    name: "feat_w"
    lr_mult: 1
  }
  param {
    name: "feat_b"
    lr_mult: 2
  }
  inner_product_param {
    num_output: 2
  }
}
</pre><h2>Define the Siamese Network</h2>
<p class="">In this section we will define the siamese network used for training. The resulting network is defined in <code>./examples/siamese/mnist_siamese_train_test.prototxt</code>.</p>
<h3>Reading in the Pair Data</h3>
<p class="">We start with a data layer that reads from the LevelDB database we created earlier. Each entry in this database contains the image data for a pair of images (<code>pair_data</code>) and a binary label saying if they belong to the same class or different classes (<code>sim</code>). </p><pre class="fragment">layer {
  name: "pair_data"
  type: "Data"
  top: "pair_data"
  top: "sim"
  include { phase: TRAIN }
  transform_param {
    scale: 0.00390625
  }
  data_param {
    source: "examples/siamese/mnist_siamese_train_leveldb"
    batch_size: 64
  }
}
</pre><p class="">In order to pack a pair of images into the same blob in the database we pack one image per channel. We want to be able to work with these two images separately, so we add a slice layer after the data layer. This takes the <code>pair_data</code> and slices it along the channel dimension so that we have a single image in <code>data</code> and its paired image in <code>data_p.</code> </p><pre class="fragment">layer {
  name: "slice_pair"
  type: "Slice"
  bottom: "pair_data"
  top: "data"
  top: "data_p"
  slice_param {
    slice_dim: 1
    slice_point: 1
  }
}
</pre><h3>Building the First Side of the Siamese Net</h3>
<p class="">Now we can specify the first side of the siamese net. This side operates on <code>data</code> and produces <code>feat</code>. Starting from the net in <code>./examples/siamese/mnist_siamese.prototxt</code> we add default weight fillers. Then we name the parameters of the convolutional and inner product layers. Naming the parameters allows Caffe to share the parameters between layers on both sides of the siamese net. In the definition this looks like: </p><pre class="fragment">...
param { name: "conv1_w" ...  }
param { name: "conv1_b" ...  }
...
param { name: "conv2_w" ...  }
param { name: "conv2_b" ...  }
...
param { name: "ip1_w" ...  }
param { name: "ip1_b" ...  }
...
param { name: "ip2_w" ...  }
param { name: "ip2_b" ...  }
...
</pre><h3>Building the Second Side of the Siamese Net</h3>
<p class="">Now we need to create the second path that operates on <code>data_p</code> and produces <code>feat_p</code>. This path is exactly the same as the first. So we can just copy and paste it. Then we change the name of each layer, input, and output by appending <code>_p</code> to differentiate the "paired" layers from the originals.</p>
<h3>Adding the Contrastive Loss Function</h3>
<p class="">To train the network we will optimize a contrastive loss function proposed in: Raia Hadsell, Sumit Chopra, and Yann LeCun "Dimensionality Reduction by Learning
an Invariant Mapping". This loss function encourages matching pairs to be close together in feature space while pushing non-matching pairs apart. This cost function is implemented with the <code>CONTRASTIVE_LOSS</code> layer: </p><pre class="fragment">layer {
    name: "loss"
    type: "ContrastiveLoss"
    contrastive_loss_param {
        margin: 1.0
    }
    bottom: "feat"
    bottom: "feat_p"
    bottom: "sim"
    top: "loss"
}
</pre><h2>Define the Solver</h2>
<p class="">Nothing special needs to be done to the solver besides pointing it at the correct model file. The solver is defined in <code>./examples/siamese/mnist_siamese_solver.prototxt</code>.</p>
<h2>Training and Testing the Model</h2>
<p class="">Training the model is simple after you have written the network definition protobuf and solver protobuf files. Simply run <code>./examples/siamese/train_mnist_siamese.sh</code>: </p><pre class="fragment">./examples/siamese/train_mnist_siamese.sh
</pre><h1>Plotting the results</h1>
<p class="">First, we can draw the model and siamese networks by running the following commands that draw the DAGs defined in the .prototxt files: </p><pre class="fragment">./python/draw_net.py \
    ./examples/siamese/mnist_siamese.prototxt \
    ./examples/siamese/mnist_siamese.png

./python/draw_net.py \
    ./examples/siamese/mnist_siamese_train_test.prototxt \
    ./examples/siamese/mnist_siamese_train_test.png
</pre><p class="">Second, we can load the learned model and plot the features using the iPython notebook: </p><pre class="fragment">ipython notebook ./examples/siamese/mnist_siamese.ipynb</pre> </div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.15 </li>
  </ul>
</div>
</body>
</html>
