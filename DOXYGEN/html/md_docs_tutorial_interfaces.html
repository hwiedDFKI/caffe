<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>caffe: interfaces</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">caffe
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_docs_tutorial_interfaces.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">interfaces </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><hr/>
 <h2>title: Interfaces </h2>
<h1>Interfaces</h1>
<p class="">Caffe has command line, Python, and MATLAB interfaces for day-to-day usage, interfacing with research code, and rapid prototyping. While Caffe is a C++ library at heart and it exposes a modular interface for development, not every occasion calls for custom compilation. The cmdcaffe, pycaffe, and matcaffe interfaces are here for you.</p>
<h2>Command Line</h2>
<p class="">The command line interface &ndash; cmdcaffe &ndash; is the <code>caffe</code> tool for model training, scoring, and diagnostics. Run <code>caffe</code> without any arguments for help. This tool and others are found in caffe/build/tools. (The following example calls require completing the LeNet / MNIST example first.)</p>
<p class=""><b>Training</b>: <code>caffe train</code> learns models from scratch, resumes learning from saved snapshots, and fine-tunes models to new data and tasks:</p>
<ul>
<li>All training requires a solver configuration through the <code>-solver solver.prototxt</code> argument.</li>
<li>Resuming requires the <code>-snapshot model_iter_1000.solverstate</code> argument to load the solver snapshot.</li>
<li>Fine-tuning requires the <code>-weights model.caffemodel</code> argument for the model initialization.</li>
</ul>
<p class="">For example, you can run: </p><pre class="fragment"># train LeNet
caffe train -solver examples/mnist/lenet_solver.prototxt
# train on GPU 2
caffe train -solver examples/mnist/lenet_solver.prototxt -gpu 2
# resume training from the half-way point snapshot
caffe train -solver examples/mnist/lenet_solver.prototxt -snapshot examples/mnist/lenet_iter_5000.solverstate
</pre><p class="">For a full example of fine-tuning, see examples/finetuning_on_flickr_style, but the training call alone is </p><pre class="fragment"># fine-tune CaffeNet model weights for style recognition
caffe train -solver examples/finetuning_on_flickr_style/solver.prototxt -weights models/bvlc_reference_caffenet/bvlc_reference_caffenet.caffemodel
</pre><p class=""><b>Testing</b>: <code>caffe test</code> scores models by running them in the test phase and reports the net output as its score. The net architecture must be properly defined to output an accuracy measure or loss as its output. The per-batch score is reported and then the grand average is reported last. </p><pre class="fragment"># score the learned LeNet model on the validation set as defined in the
# model architeture lenet_train_test.prototxt
caffe test -model examples/mnist/lenet_train_test.prototxt -weights examples/mnist/lenet_iter_10000.caffemodel -gpu 0 -iterations 100
</pre><p class=""><b>Benchmarking</b>: <code>caffe time</code> benchmarks model execution layer-by-layer through timing and synchronization. This is useful to check system performance and measure relative execution times for models. </p><pre class="fragment"># (These example calls require you complete the LeNet / MNIST example first.)
# time LeNet training on CPU for 10 iterations
caffe time -model examples/mnist/lenet_train_test.prototxt -iterations 10
# time LeNet training on GPU for the default 50 iterations
caffe time -model examples/mnist/lenet_train_test.prototxt -gpu 0
# time a model architecture with the given weights on the first GPU for 10 iterations
caffe time -model examples/mnist/lenet_train_test.prototxt -weights examples/mnist/lenet_iter_10000.caffemodel -gpu 0 -iterations 10
</pre><p class=""><b>Diagnostics</b>: <code>caffe device_query</code> reports GPU details for reference and checking device ordinals for running on a given device in multi-GPU machines. </p><pre class="fragment"># query the first device
caffe device_query -gpu 0
</pre><p class=""><b>Parallelism</b>: the <code>-gpu</code> flag to the <code>caffe</code> tool can take a comma separated list of IDs to run on multiple GPUs. A solver and net will be instantiated for each GPU so the batch size is effectively multiplied by the number of GPUs. To reproduce single GPU training, reduce the batch size in the network definition accordingly. </p><pre class="fragment"># train on GPUs 0 &amp; 1 (doubling the batch size)
caffe train -solver examples/mnist/lenet_solver.prototxt -gpu 0,1
# train on all GPUs (multiplying batch size by number of devices)
caffe train -solver examples/mnist/lenet_solver.prototxt -gpu all
</pre><h2>Python</h2>
<p class="">The Python interface &ndash; pycaffe &ndash; is the <code>caffe</code> module and its scripts in caffe/python. <code>import caffe</code> to load models, do forward and backward, handle IO, visualize networks, and even instrument model solving. All model data, derivatives, and parameters are exposed for reading and writing.</p>
<ul>
<li><code><a class="el" href="classcaffe_1_1_net.html" title="Connects Layers together into a directed acyclic graph (DAG) specified by a NetParameter. ">caffe.Net</a></code> is the central interface for loading, configuring, and running models. <code>caffe.Classifier</code> and <code>caffe.Detector</code> provide convenience interfaces for common tasks.</li>
<li><code><a class="el" href="classcaffe_1_1_s_g_d_solver.html" title="Optimizes the parameters of a Net using stochastic gradient descent (SGD) with momentum. ">caffe.SGDSolver</a></code> exposes the solving interface.</li>
<li><code>caffe.io</code> handles input / output with preprocessing and protocol buffers.</li>
<li><code><a class="el" href="namespacecaffe_1_1draw.html">caffe.draw</a></code> visualizes network architectures.</li>
<li>Caffe blobs are exposed as numpy ndarrays for ease-of-use and efficiency.</li>
</ul>
<p class="">Tutorial IPython notebooks are found in caffe/examples: do <code>ipython notebook caffe/examples</code> to try them. For developer reference docstrings can be found throughout the code.</p>
<p class="">Compile pycaffe by <code>make pycaffe</code>. Add the module directory to your <code>$PYTHONPATH</code> by <code>export PYTHONPATH=/path/to/caffe/python:$PYTHONPATH</code> or the like for <code>import caffe</code>.</p>
<h2>MATLAB</h2>
<p class="">The MATLAB interface &ndash; matcaffe &ndash; is the <code>caffe</code> package in caffe/matlab in which you can integrate Caffe in your Matlab code.</p>
<p class="">In MatCaffe, you can</p>
<ul>
<li>Creating multiple Nets in Matlab</li>
<li>Do forward and backward computation</li>
<li>Access any layer within a network, and any parameter blob in a layer</li>
<li>Get and set data or diff to any blob within a network, not restricting to input blobs or output blobs</li>
<li>Save a network's parameters to file, and load parameters from file</li>
<li>Reshape a blob and reshape a network</li>
<li>Edit network parameter and do network surgery</li>
<li>Create multiple Solvers in Matlab for training</li>
<li>Resume training from solver snapshots</li>
<li>Access train net and test nets in a solver</li>
<li>Run for a certain number of iterations and give back control to Matlab</li>
<li>Intermingle arbitrary Matlab code with gradient steps</li>
</ul>
<p class="">An ILSVRC image classification demo is in caffe/matlab/demo/classification_demo.m (you need to download BAIR CaffeNet from <a href="http://caffe.berkeleyvision.org/model_zoo.html">Model Zoo</a> to run it).</p>
<h3>Build MatCaffe</h3>
<p class="">Build MatCaffe with <code>make all matcaffe</code>. After that, you may test it using <code>make mattest</code>.</p>
<p class="">Common issue: if you run into error messages like &lsquo;libstdc++.so.6:version 'GLIBCXX_3.4.15&rsquo; not found<code>during</code>make mattest`, then it usually means that your Matlab's runtime libraries do not match your compile-time libraries. You may need to do the following before you start Matlab: </p><pre class="fragment">export LD_LIBRARY_PATH=/opt/intel/mkl/lib/intel64:/usr/local/cuda/lib64
export LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libstdc++.so.6
</pre><p class="">Or the equivalent based on where things are installed on your system, and do <code>make mattest</code> again to see if the issue is fixed. Note: this issue is sometimes more complicated since during its startup Matlab may overwrite your <code>LD_LIBRARY_PATH</code> environment variable. You can run <code>!ldd ./matlab/+caffe/private/caffe_.mexa64</code> (the mex extension may differ on your system) in Matlab to see its runtime libraries, and preload your compile-time libraries by exporting them to your <code>LD_PRELOAD</code> environment variable.</p>
<p class="">After successful building and testing, add this package to Matlab search PATH by starting <code>matlab</code> from caffe root folder and running the following commands in Matlab command window. </p><pre class="fragment">addpath ./matlab
</pre><p class="">You can save your Matlab search PATH by running <code>savepath</code> so that you don't have to run the command above again every time you use MatCaffe.</p>
<h3>Use MatCaffe</h3>
<p class="">MatCaffe is very similar to PyCaffe in usage.</p>
<p class="">Examples below shows detailed usages and assumes you have downloaded BAIR CaffeNet from <a href="http://caffe.berkeleyvision.org/model_zoo.html">Model Zoo</a> and started <code>matlab</code> from caffe root folder. </p><pre class="fragment">model = './models/bvlc_reference_caffenet/deploy.prototxt';
weights = './models/bvlc_reference_caffenet/bvlc_reference_caffenet.caffemodel';
</pre><h4>Set mode and device</h4>
<p class=""><b>Mode and device should always be set BEFORE you create a net or a solver.</b></p>
<p class="">Use CPU: </p><pre class="fragment">caffe.set_mode_cpu();
</pre><p class="">Use GPU and specify its gpu_id: </p><pre class="fragment">caffe.set_mode_gpu();
caffe.set_device(gpu_id);
</pre><h4>Create a network and access its layers and blobs</h4>
<p class="">Create a network: </p><pre class="fragment">net = caffe.Net(model, weights, 'test'); % create net and load weights
</pre><p class="">Or </p><pre class="fragment">net = caffe.Net(model, 'test'); % create net but not load weights
net.copy_from(weights); % load weights
</pre><p class="">which creates <code>net</code> object as </p><pre class="fragment">  Net with properties:

           layer_vec: [1x23 caffe.Layer]
            blob_vec: [1x15 caffe.Blob]
              inputs: {'data'}
             outputs: {'prob'}
    name2layer_index: [23x1 containers.Map]
     name2blob_index: [15x1 containers.Map]
         layer_names: {23x1 cell}
          blob_names: {15x1 cell}
</pre><p class="">The two <code>containers.Map</code> objects are useful to find the index of a layer or a blob by its name.</p>
<p class="">You have access to every blob in this network. To fill blob 'data' with all ones: </p><pre class="fragment">net.blobs('data').set_data(ones(net.blobs('data').shape));
</pre><p class="">To multiply all values in blob 'data' by 10: </p><pre class="fragment">net.blobs('data').set_data(net.blobs('data').get_data() * 10);
</pre><p class=""><b>Be aware that since Matlab is 1-indexed and column-major, the usual 4 blob dimensions in Matlab are <code>[width, height, channels, num]</code>, and <code>width</code> is the fastest dimension. Also be aware that images are in BGR channels.</b> Also, Caffe uses single-precision float data. If your data is not single, <code>set_data</code> will automatically convert it to single.</p>
<p class="">You also have access to every layer, so you can do network surgery. For example, to multiply conv1 parameters by 10: </p><pre class="fragment">net.params('conv1', 1).set_data(net.params('conv1', 1).get_data() * 10); % set weights
net.params('conv1', 2).set_data(net.params('conv1', 2).get_data() * 10); % set bias
</pre><p class="">Alternatively, you can use </p><pre class="fragment">net.layers('conv1').params(1).set_data(net.layers('conv1').params(1).get_data() * 10);
net.layers('conv1').params(2).set_data(net.layers('conv1').params(2).get_data() * 10);
</pre><p class="">To save the network you just modified: </p><pre class="fragment">net.save('my_net.caffemodel');
</pre><p class="">To get a layer's type (string): </p><pre class="fragment">layer_type = net.layers('conv1').type;
</pre><h4>Forward and backward</h4>
<p class="">Forward pass can be done using <code>net.forward</code> or <code>net.forward_prefilled</code>. Function <code>net.forward</code> takes in a cell array of N-D arrays containing data of input blob(s) and outputs a cell array containing data from output blob(s). Function <code>net.forward_prefilled</code> uses existing data in input blob(s) during forward pass, takes no input and produces no output. After creating some data for input blobs like &lsquo;data = rand(net.blobs('data&rsquo;).shape);` you can run </p><pre class="fragment">res = net.forward({data});
prob = res{1};
</pre><p class="">Or </p><pre class="fragment">net.blobs('data').set_data(data);
net.forward_prefilled();
prob = net.blobs('prob').get_data();
</pre><p class="">Backward is similar using <code>net.backward</code> or <code>net.backward_prefilled</code> and replacing <code>get_data</code> and <code>set_data</code> with <code>get_diff</code> and <code>set_diff</code>. After creating some gradients for output blobs like &lsquo;prob_diff = rand(net.blobs('prob&rsquo;).shape);` you can run </p><pre class="fragment">res = net.backward({prob_diff});
data_diff = res{1};
</pre><p class="">Or </p><pre class="fragment">net.blobs('prob').set_diff(prob_diff);
net.backward_prefilled();
data_diff = net.blobs('data').get_diff();
</pre><p class="">**However, the backward computation above doesn't get correct results, because Caffe decides that the network does not need backward computation. To get correct backward results, you need to set &lsquo;'force_backward: true&rsquo;` in your network prototxt.**</p>
<p class="">After performing forward or backward pass, you can also get the data or diff in internal blobs. For example, to extract pool5 features after forward pass: </p><pre class="fragment">pool5_feat = net.blobs('pool5').get_data();
</pre><h4>Reshape</h4>
<p class="">Assume you want to run 1 image at a time instead of 10: </p><pre class="fragment">net.blobs('data').reshape([227 227 3 1]); % reshape blob 'data'
net.reshape();
</pre><p class="">Then the whole network is reshaped, and now &lsquo;net.blobs('prob&rsquo;).shape<code>should be</code>[1000 1]`;</p>
<h4>Training</h4>
<p class="">Assume you have created training and validation lmdbs following our <a href="http://caffe.berkeleyvision.org/gathered/examples/imagenet.html">ImageNET Tutorial</a>, to create a solver and train on ILSVRC 2012 classification dataset: </p><pre class="fragment">solver = caffe.Solver('./models/bvlc_reference_caffenet/solver.prototxt');
</pre><p class="">which creates <code>solver</code> object as </p><pre class="fragment">  Solver with properties:

          net: [1x1 caffe.Net]
    test_nets: [1x1 caffe.Net]
</pre><p class="">To train: </p><pre class="fragment">solver.solve();
</pre><p class="">Or train for only 1000 iterations (so that you can do something to its net before training more iterations) </p><pre class="fragment">solver.step(1000);
</pre><p class="">To get iteration number: </p><pre class="fragment">iter = solver.iter();
</pre><p class="">To get its network: </p><pre class="fragment">train_net = solver.net;
test_net = solver.test_nets(1);
</pre><p class="">To resume from a snapshot "your_snapshot.solverstate": </p><pre class="fragment">solver.restore('your_snapshot.solverstate');
</pre><h4>Input and output</h4>
<p class=""><code>caffe.io</code> class provides basic input functions <code>load_image</code> and <code>read_mean</code>. For example, to read ILSVRC 2012 mean file (assume you have downloaded imagenet example auxiliary files by running <code>./data/ilsvrc12/get_ilsvrc_aux.sh</code>): </p><pre class="fragment">mean_data = caffe.io.read_mean('./data/ilsvrc12/imagenet_mean.binaryproto');
</pre><p class="">To read Caffe's example image and resize to <code>[width, height]</code> and suppose we want <code>width = 256; height = 256;</code> </p><pre class="fragment">im_data = caffe.io.load_image('./examples/images/cat.jpg');
im_data = imresize(im_data, [width, height]); % resize using Matlab's imresize
</pre><p class=""><b>Keep in mind that <code>width</code> is the fastest dimension and channels are BGR, which is different from the usual way that Matlab stores an image.</b> If you don't want to use <code>caffe.io.load_image</code> and prefer to load an image by yourself, you can do </p><pre class="fragment">im_data = imread('./examples/images/cat.jpg'); % read image
im_data = im_data(:, :, [3, 2, 1]); % convert from RGB to BGR
im_data = permute(im_data, [2, 1, 3]); % permute width and height
im_data = single(im_data); % convert to single precision
</pre><p class="">Also, you may take a look at caffe/matlab/demo/classification_demo.m to see how to prepare input by taking crops from an image.</p>
<p class="">We show in caffe/matlab/hdf5creation how to read and write HDF5 data with Matlab. We do not provide extra functions for data output as Matlab itself is already quite powerful in output.</p>
<h4>Clear nets and solvers</h4>
<p class="">Call <code>caffe.reset_all()</code> to clear all solvers and stand-alone nets you have created. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.15 </li>
  </ul>
</div>
</body>
</html>
